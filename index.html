<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSV/XLSX Code Compare (Local)</title>

    <!-- CSS -->
    <style>
        :root {
            --bg: #0b1220;
            --panel: rgba(255, 255, 255, 0.06);
            --panelBorder: rgba(255, 255, 255, 0.10);
            --field: rgba(255, 255, 255, 0.08);
            --fieldBorder: rgba(255, 255, 255, 0.14);
            --text: #e7eefc;
            --muted: rgba(231, 238, 252, 0.72);
            --accent: #2b6cff;
            --shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        }

        html {
            color-scheme: dark;
        }

        body {
            margin: 24px;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            overflow-x: hidden;
        }

        h1 {
            font-size: 20px;
            margin: 0 0 10px;
        }

        .sub {
            color: var(--muted);
            font-size: 12px;
            margin: 0 0 18px;
            max-width: 1200px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .card {
            flex: 1 1 360px;
            min-width: 320px;
            background: var(--panel);
            border: 1px solid var(--panelBorder);
            border-radius: 14px;
            padding: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card h2 {
            font-size: 14px;
            margin: 0 0 10px;
            opacity: .92;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .grid>* {
            min-width: 0;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin: 8px 0 6px;
            line-height: 1.2;
        }

        .labelRow {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0 6px;
        }

        .labelRow label {
            margin: 0;
        }

        .badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(43, 108, 255, 0.35);
            background: rgba(43, 108, 255, 0.14);
            color: rgba(231, 238, 252, 0.9);
            white-space: nowrap;
        }

        .badge.opt {
            border: 1px solid rgba(255, 255, 255, 0.20);
            background: rgba(255, 255, 255, 0.08);
            color: rgba(231, 238, 252, 0.75);
        }

        .appHeader{
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 18px;
        }

        .appLogo{
            height: 56px;
            width: auto;
            flex-shrink: 0;
        }

        .appTitle h1{
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .appTitle p{
            margin: 2px 0 0;
            font-size: 12px;
            color: var(--muted);
        }

        .appLogo{
            height: 70px;
            filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
        }

        select,
        input,
        textarea,
        button {
            font: inherit;
        }

        .filewrap {
            min-width: 0;
        }

        input[type="file"] {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid var(--fieldBorder);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
        }

        select,
        input,
        textarea {
            width: 100%;
            box-sizing: border-box;
            background: var(--field);
            color: var(--text);
            border: 1px solid var(--fieldBorder);
            border-radius: 10px;
            padding: 10px 10px;
            outline: none;
        }

        /* --- Fix checkbox looking like a full-width input --- */
        input[type="checkbox"]{
        width: auto !important;
        padding: 0 !important;
        border-radius: 4px !important;
        border: 1px solid rgba(255,255,255,0.25) !important;
        background: rgba(255,255,255,0.06) !important;
        appearance: auto;
        -webkit-appearance: auto;
        }

        /* Better layout for the ignore row */
        .filtersBlank{
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
        width: fit-content;
        }

        .filtersBlank:hover{
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.14);
        }

        .filtersBlank span{
        color: rgba(231,238,252,0.82);
        font-size: 12px;
        white-space: nowrap;
        }


        option {
            background: #101a2e;
            color: var(--text);
        }

        select:focus,
        input:focus,
        textarea:focus {
            border-color: rgba(43, 108, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(43, 108, 255, 0.18);
        }

        textarea {
            min-height: 84px;
            resize: vertical;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .right {
            margin-left: auto;
        }

        button {
            background: var(--accent);
            border: 0;
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 650;
        }

        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .btnGhost {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(231, 238, 252, 0.92);
            padding: 10px 12px;
            font-weight: 600;
        }

        .btnGhost:hover {
            background: rgba(255, 255, 255, 0.10);
        }

        .tablewrap {
            overflow: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.03);
            max-width: 100%;
            min-width: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 980px;
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            vertical-align: top;
        }

        th {
            position: sticky;
            top: 0;
            background: rgba(11, 18, 32, 0.95);
            text-align: left;
            font-size: 12px;
            letter-spacing: .02em;
            z-index: 1;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        tr.selected {
            background: rgba(43, 108, 255, 0.10);
            outline: 1px solid rgba(43, 108, 255, 0.30);
            outline-offset: -1px;
        }

        .pill {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            white-space: nowrap;
        }

        .ok {
            background: rgba(43, 255, 155, 0.12);
            border: 1px solid rgba(43, 255, 155, 0.25);
        }

        .bad {
            background: rgba(255, 77, 77, 0.12);
            border: 1px solid rgba(255, 77, 77, 0.25);
        }

        .add {
            background: rgba(43, 108, 255, 0.12);
            border: 1px solid rgba(43, 108, 255, 0.25);
        }

        .rem {
            background: rgba(255, 195, 77, 0.12);
            border: 1px solid rgba(255, 195, 77, 0.25);
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 12px;
        }

        .keyCell {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 0;
        }

        .keyText {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1 1 auto;
            min-width: 0;
        }

        .copyBtn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(231, 238, 252, 0.92);
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            line-height: 1;
        }

        .copyBtn:hover {
            background: rgba(255, 255, 255, 0.10);
        }

        .diffbox {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 12px;
            align-items: start;
        }

        .diffbox>div {
            min-width: 0;
        }

        pre {
            margin: 0;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.05);
            overflow: auto;
            max-height: 360px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            white-space: pre;
            word-break: normal;
            min-width: 0;
            scrollbar-gutter: stable both-edges;
        }

        .splitRow {
            display: grid;
            grid-template-columns: minmax(360px, 1fr) 18px minmax(420px, 2fr);
            align-items: stretch;
            gap: 12px;
            width: 100%;
            max-width: 100%;
        }

        .splitRow>.card {
            min-width: 0;
            max-width: 100%;
        }

        .splitter {
            cursor: col-resize;
            width: 18px;
            border-radius: 999px;
            margin: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.14);
            position: relative;
            z-index: 1;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.25);
            touch-action: none;
        }

        .splitter::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 60px;
            transform: translate(-50%, -50%);
            border-radius: 999px;
            background: radial-gradient(circle, rgba(231, 238, 252, 0.65) 2px, transparent 3px) 0 0 / 6px 10px;
            opacity: 0.85;
        }

        .splitter:hover {
            background: rgba(43, 108, 255, 0.16);
            border-color: rgba(43, 108, 255, 0.45);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(43, 108, 255, 0.10);
        }

        .splitter.dragging {
            background: rgba(43, 108, 255, 0.24);
            border-color: rgba(43, 108, 255, 0.65);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.25), 0 0 0 6px rgba(43, 108, 255, 0.12);
        }

        .line {
            display: block;
            padding: 0 6px;
            border-radius: 6px;
            width: max-content;
            min-width: 100%;
        }

        .line.add {
            background: rgba(43, 255, 155, 0.10);
        }

        .line.del {
            background: rgba(255, 77, 77, 0.10);
        }

        .line.same {
            opacity: .9;
        }

        .line.empty {
            opacity: 0.55;
        }

        .pager {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .pager .spacer {
            flex: 1 1 auto;
        }

        .toast {
            position: fixed;
            bottom: 18px;
            left: 18px;
            background: rgba(20, 28, 48, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(231, 238, 252, 0.92);
            padding: 10px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-size: 12px;
            opacity: 0;
            transform: translateY(6px);
            pointer-events: none;
            transition: opacity 140ms ease, transform 140ms ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }


        /* Filters footer: stacked, clean, never awkward */
        .filtersBar{
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 12px;
        }

        .filtersShowRow{
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
        }

        .filtersShowRow select{
        width: 220px;
        }

        .filtersSearchRow{
        display: flex;
        gap: 10px;
        align-items: center;   /* <- key: vertical alignment */
        min-width: 0;
        }

        .filtersSearchRow .searchLabel{
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        margin: 0;             /* <- key: no inherited label margins */
        line-height: 1;        /* <- keeps it centered */
        padding-top: 1px;      /* tiny nudge to match input baseline */
        display: inline-block;
        }

        .filtersSearchRow input{
        flex: 1;
        min-width: 0;
        }


        /* Small screens: make Show dropdown full width */
        @media (max-width: 520px){
        .filtersShowRow{
            flex-direction: column;
            align-items: stretch;
        }
        .filtersShowRow select{
            width: 100%;
        }
        }


        /* Small: dropdown full width */
        @media (max-width: 520px){
        .filtersShow{
            flex-direction: column;
            align-items: stretch;
        }
        .filtersShow select{
            width: 100% !important;
        }
        }


        @media (max-width: 980px) {
            body {
                margin: 14px;
            }

            .card {
                min-width: 280px;
            }

            .diffbox {
                grid-template-columns: 1fr;
            }

            table {
                min-width: 860px;
            }

            .splitRow {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .splitter {
                display: none;
            }
        }

        @media (max-width: 720px) {
            .grid {
                grid-template-columns: 1fr !important;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls .right {
                margin-left: 0;
            }

            table {
                min-width: 760px;
            }
        }
    </style>
</head>

<body>
    <header class="appHeader">
        <img src="assets/logo.png" alt="Code Compare logo" class="appLogo">
        <div class="appTitle">
            <p>Upload old + new exports, map columns, filter, normalize, and compare by key.</p>
        </div>
    </header>
    
    <h1>Local CSV/XLSX Code Comparator</h1>
    <p class="sub">
        Upload old + new exports, map columns, filter by author/object, choose normalization, then compare by key.
    </p>

    <div class="row">
        <div class="card">
            <h2>1) Upload files</h2>
            <div class="grid">
                <div>
                    <label>Old file (CSV / XLSX)</label>
                    <div class="filewrap">
                        <input type="file" id="oldFile" accept=".csv,.xlsx,.xls" />
                    </div>
                    <div class="muted" id="oldInfo"></div>
                </div>
                <div>
                    <label>New file (CSV / XLSX)</label>
                    <div class="filewrap">
                        <input type="file" id="newFile" accept=".csv,.xlsx,.xls" />
                    </div>
                    <div class="muted" id="newInfo"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>2) Map columns</h2>

            <div class="grid">
                <div>
                    <div class="labelRow">
                        <label>Key / Object column (match rows)</label>
                        <span class="badge">Required</span>
                    </div>
                    <select id="colKey"></select>
                </div>

                <div>
                    <div class="labelRow">
                        <label>Secondary key column</label>
                        <span class="badge opt">Optional</span>
                    </div>
                    <select id="colKey2"></select>
                </div>

                <div>
                    <div class="labelRow">
                        <label>Code snippet column to compare</label>
                        <span class="badge">Required</span>
                    </div>
                    <select id="colCode"></select>
                </div>

                <div>
                    <div class="labelRow">
                        <label>Author column</label>
                        <span class="badge opt">Optional</span>
                    </div>
                    <select id="colAuthor"></select>
                </div>

                <div>
                    <div class="labelRow">
                        <label>Date column</label>
                        <span class="badge opt">Optional</span>
                    </div>
                    <select id="colDate"></select>
                </div>

                <div>
                    <div class="labelRow">
                        <label>Normalize</label>
                        <span class="badge opt">Optional</span>
                    </div>
                    <select id="normalizeMode">
                        <option value="none" selected>No normalization (default)</option>
                        <option value="trim">Trim trailing spaces</option>
                        <option value="collapse_ws">Collapse whitespace (aggressive)</option>
                        <option value="strip_comments_abap">Strip ABAP comments (naive)</option>
                    </select>
                </div>
            </div>

            <div class="controls">
                <label class="filtersBlank" style="margin:0;">
                    <input type="checkbox" id="ignoreBlankLines" />
                    <span>Ignore blank lines</span>
                </label>

                <button id="compareBtn" class="right" disabled type="button">Compare</button>
            </div>
        </div>

        <div class="card">
            <h2>3) Filters </h2>

            <div class="grid">
                <div>
                    <label>Authors to include (one per line)</label>
                    <textarea id="filterAuthors" placeholder="John Doe&#10;Jane Doe"></textarea>
                </div>
                <div>
                    <label>Objects to include (one per line)</label>
                    <textarea id="filterObjects" placeholder="ZCL_FOO&#10;ZIF_BAR"></textarea>
                </div>
            </div>

            <div class="filtersBar">
                <div class="filtersShowRow">
                    <label style="margin:0;color:var(--muted);">Show</label>
                    <select id="showOnly">
                        <option value="all">All</option>
                        <option value="changed">Changed only</option>
                        <option value="unchanged">Unchanged only</option>
                        <option value="added">Added in new</option>
                        <option value="removed">Removed in new</option>
                    </select>
                </div>
            
                <div class="filtersSearchRow">
                    <span class="searchLabel">Search</span>
                    <input id="search" placeholder="key/object..." />
                </div>
            </div>
        </div>
    </div>

    <div class="splitRow" style="margin-top: 16px;">
        <div class="card" id="resultsCard">
            <h2>Results</h2>
            <div class="controls">
                <div id="stats" class="muted"></div>

                <button id="exportCsvBtn" class="right" disabled type="button">Export CSV</button>
                <button id="exportXlsxBtn" disabled type="button">Export XLSX</button>
            </div>

            <div class="tablewrap" style="margin-top:10px;">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Key</th>
                            <th>Old author</th>
                            <th>New author</th>
                            <th>Old date</th>
                            <th>New date</th>
                            <th>Diff preview</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="pager">
                <button id="prevPageBtn" class="btnGhost" type="button" disabled>Prev</button>
                <button id="nextPageBtn" class="btnGhost" type="button" disabled>Next</button>
                <div class="muted" id="pageInfo"></div>
                <div class="spacer"></div>
                <label style="margin:0;color:var(--muted);">Page size</label>
                <select id="pageSize" style="width:120px;">
                    <option>50</option>
                    <option>100</option>
                    <option>200</option>
                    <option>500</option>
                </select>
            </div>

            <p class="muted" style="margin-top:10px;">Click a row to see full side-by-side diff.</p>
        </div>

        <div class="splitter" id="splitter" title="Drag to resize"></div>

        <div class="card" id="diffCard">
            <h2>Diff viewer</h2>
            <div class="muted" id="diffTitle">Select a row with ❌ to view differences.</div>

            <div class="diffbox" style="margin-top: 10px;">
                <div>
                    <label>Old</label>
                    <pre id="oldDiff" class="mono"></pre>
                </div>
                <div>
                    <label>New</label>
                    <pre id="newDiff" class="mono"></pre>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- CSV parser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- XLSX parser + writer -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Proper diff library (line-based) -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>

    <script>
        const state = {
            oldRows: [],
            newRows: [],
            cols: [],
            results: [],              // metadata only (no huge code blobs)
            oldMap: new Map(),        // key -> row
            newMap: new Map(),        // key -> row
            reportCsv: "",
            // paging + view
            viewRows: [],
            page: 1,
            pageSize: 50,
            selectedKey: null
        };

        const $ = (id) => document.getElementById(id);

        function showToast(msg) {
            const el = $("toast");
            el.textContent = msg;
            el.classList.add("show");
            setTimeout(() => el.classList.remove("show"), 950);
        }

        function linesToSet(text) {
            return new Set(
                (text || "")
                    .split("\n")
                    .map(s => s.trim())
                    .filter(Boolean)
                    .map(s => s.toLowerCase())
            );
        }

        // Safe key encoding: JSON array of trimmed parts (prevents delimiter collisions)
        function buildKey(row, keyCols) {
            const parts = keyCols.map(c => (row?.[c] ?? "").toString().trim());
            return JSON.stringify(parts);
        }

        function getColumns(rows) {
            const cols = new Set();
            rows.forEach(r => Object.keys(r || {}).forEach(k => cols.add(k)));
            return Array.from(cols);
        }

        function fillSelect(selectEl, cols) {
            selectEl.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(none)";
            selectEl.appendChild(opt);

            cols.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                selectEl.appendChild(o);
            });
        }

        function guessColumn(cols, patterns) {
            const lc = cols.map(c => ({ c, lc: c.toLowerCase() }));
            for (const p of patterns) {
                const hit = lc.find(x => x.lc === p) || lc.find(x => x.lc.includes(p));
                if (hit) return hit.c;
            }
            return "";
        }

        // More robust date parsing than Date.parse for common export formats
        function parseDateMaybe(v) {
            const s = (v ?? "").toString().trim();
            if (!s) return null;

            // ISO-ish: 2025-11-20 14:30 or 2025-11-20T14:30:00
            let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
            if (m) {
                const y = +m[1], mo = +m[2], d = +m[3];
                const hh = +(m[4] ?? 0), mm = +(m[5] ?? 0), ss = +(m[6] ?? 0);
                const t = Date.UTC(y, mo - 1, d, hh, mm, ss);
                return Number.isFinite(t) ? t : null;
            }

            // EU-ish: 20-11-2025 14:30 or 20/11/2025
            m = s.match(/^(\d{2})[\/.-](\d{2})[\/.-](\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
            if (m) {
                const d = +m[1], mo = +m[2], y = +m[3];
                const hh = +(m[4] ?? 0), mm = +(m[5] ?? 0), ss = +(m[6] ?? 0);
                const t = Date.UTC(y, mo - 1, d, hh, mm, ss);
                return Number.isFinite(t) ? t : null;
            }

            // Fallback
            const t = Date.parse(s);
            return Number.isFinite(t) ? t : null;
        }

        function readFile(file) {
            const name = file.name.toLowerCase();

            if (name.endsWith(".csv") || name.endsWith(".txt")) {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: reject
                    });
                });
            }

            if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const wb = XLSX.read(data, { type: "array" });
                            const sheetName = wb.SheetNames[0];
                            const ws = wb.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
                            resolve(json);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            return Promise.reject(new Error("Unsupported file type"));
        }

        function stripInlineAbapCommentSafish(line) {
            const s = (line ?? "").toString();
            let out = "";
            let inSingle = false;

            for (let i = 0; i < s.length; i++) {
                const ch = s[i];

                if (ch === "'") {
                    // ABAP string escape: '' inside string
                    if (inSingle && i + 1 < s.length && s[i + 1] === "'") {
                        out += "''";
                        i++;
                        continue;
                    }
                    inSingle = !inSingle;
                    out += ch;
                    continue;
                }

                if (ch === '"' && !inSingle) {
                    return out.replace(/\s+$/g, "");
                }

                out += ch;
            }
            return out.replace(/\s+$/g, "");
        }

        function normalizeCode(code, mode, ignoreBlankLines) {
            const s = (code ?? "").toString().replace(/\r\n/g, "\n").replace(/\r/g, "\n");

            let out = s;

            if (mode === "none") {
                out = s;
            } else if (mode === "trim") {
                out = s.split("\n").map(line => line.replace(/\s+$/g, "")).join("\n");
            } else if (mode === "collapse_ws") {
                out = s.replace(/\s+/g, " ").trim();
            } else if (mode === "strip_comments_abap") {
                const lines = [];
                for (const line of s.split("\n")) {
                    const raw = line.replace(/\s+$/g, "");
                    if (raw.trimStart().startsWith("*")) continue;
                    lines.push(stripInlineAbapCommentSafish(raw));
                }
                out = lines.join("\n");
            }

            if (ignoreBlankLines) {
                out = out.split("\n").filter(ln => ln.trim() !== "").join("\n");
            }

            return out;
        }

        function dedupeLatestByDate(rows, keyCols, dateCol) {
            const map = new Map();
            for (const r of rows) {
                const key = buildKey(r, keyCols);
                if (!key) continue;

                if (!map.has(key)) {
                    map.set(key, r);
                    continue;
                }

                if (!dateCol) {
                    map.set(key, r);
                    continue;
                }

                const cur = map.get(key);
                const t1 = parseDateMaybe(cur?.[dateCol] ?? "") ?? -Infinity;
                const t2 = parseDateMaybe(r?.[dateCol] ?? "") ?? -Infinity;
                if (t2 >= t1) map.set(key, r);
            }
            return map;
        }

        function statusPill(status) {
            if (status === "UNCHANGED") return `<span class="pill ok">✅ Same</span>`;
            if (status === "CHANGED") return `<span class="pill bad">❌ Diff</span>`;
            if (status === "ADDED") return `<span class="pill add">➕ Added</span>`;
            if (status === "REMOVED") return `<span class="pill rem">➖ Removed</span>`;
            return status;
        }

        // Proper line diff -> aligned rows for side-by-side rendering
        function buildAlignedDiff(oldText, newText) {
            const parts = Diff.diffLines(oldText, newText); // line-based diff
            const oldLines = [];
            const newLines = [];
            const oldCls = [];
            const newCls = [];

            for (const p of parts) {
                const lines = (p.value ?? "").split("\n");
                // diffLines keeps trailing newline in the "value", which creates a trailing ""
                // We'll keep alignment stable by removing the last empty line only if it's from split end.
                if (lines.length && lines[lines.length - 1] === "") lines.pop();

                if (p.added) {
                    for (const ln of lines) {
                        oldLines.push("");
                        newLines.push(ln);
                        oldCls.push("empty");
                        newCls.push("add");
                    }
                } else if (p.removed) {
                    for (const ln of lines) {
                        oldLines.push(ln);
                        newLines.push("");
                        oldCls.push("del");
                        newCls.push("empty");
                    }
                } else {
                    for (const ln of lines) {
                        oldLines.push(ln);
                        newLines.push(ln);
                        oldCls.push("same");
                        newCls.push("same");
                    }
                }
            }

            // preview metrics
            let same = 0;
            for (let i = 0; i < oldLines.length; i++) {
                if (oldCls[i] === "same" && newCls[i] === "same") same++;
            }

            return { oldLines, newLines, oldCls, newCls, sameLines: same, totalLines: oldLines.length };
        }

        function renderDiff(preEl, lines, classes) {
            preEl.textContent = "";
            const frag = document.createDocumentFragment();
            for (let i = 0; i < lines.length; i++) {
                const span = document.createElement("span");
                span.className = "line " + (classes[i] || "same");
                span.textContent = lines[i] + (i === lines.length - 1 ? "" : "\n");
                frag.appendChild(span);
            }
            preEl.appendChild(frag);
        }

        function getCodeForKey(key) {
            const colCode = $("colCode").value;
            const mode = $("normalizeMode").value;
            const ignoreBlankLines = $("ignoreBlankLines").checked;

            const o = state.oldMap.get(key);
            const n = state.newMap.get(key);

            const oldCode = normalizeCode(o?.[colCode] ?? "", mode, ignoreBlankLines);
            const newCode = normalizeCode(n?.[colCode] ?? "", mode, ignoreBlankLines);
            return { oldCode, newCode };
        }

        function buildReportCsv(rows) {
            const header = [
                "Status", "Key", "SecondaryKey",
                "OldAuthor", "NewAuthor",
                "OldDate", "NewDate",
                "OldCode", "NewCode"
            ];

            const esc = (v) => `"${String(v).replaceAll('"', '""')}"`;

            const lines = [];
            lines.push(header.map(esc).join(","));

            for (const r of rows) {
                // Export only diffs (UNCHANGED excluded by caller)
                const { oldCode, newCode } = getCodeForKey(r.key);

                lines.push([
                    r.status,
                    r.keyPrimary ?? "",
                    r.keySecondary ?? "",
                    r.oldAuthor ?? "",
                    r.newAuthor ?? "",
                    r.oldDate ?? "",
                    r.newDate ?? "",
                    oldCode ?? "",
                    newCode ?? ""
                ].map(esc).join(","));
            }

            return lines.join("\n");
        }

        function downloadText(filename, text, mime = "text/plain") {
            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function exportReportXlsx(rows) {
            try {
                const headers = [
                    "Status", "Key", "SecondaryKey", "OldAuthor", "NewAuthor",
                    "OldDate", "NewDate", "OldCode", "NewCode"
                ];

                const aoa = [headers];

                for (const r of rows) {
                    const { oldCode, newCode } = getCodeForKey(r.key);
                    aoa.push([
                        r.status,
                        r.keyPrimary ?? "",
                        r.keySecondary ?? "",
                        r.oldAuthor ?? "",
                        r.newAuthor ?? "",
                        r.oldDate ?? "",
                        r.newDate ?? "",
                        oldCode ?? "",
                        newCode ?? ""
                    ]);
                }

                const ws = XLSX.utils.aoa_to_sheet(aoa);

                ws["!cols"] = [
                    { wch: 10 }, { wch: 22 }, { wch: 16 }, { wch: 16 }, { wch: 16 },
                    { wch: 18 }, { wch: 18 }, { wch: 60 }, { wch: 60 }
                ];

                const range = XLSX.utils.decode_range(ws["!ref"] || "A1:A1");
                ws["!autofilter"] = { ref: XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: 0, c: range.e.c } }) };

                // NOTE: Styling support can vary depending on the build of the XLSX library.
                // This is safe to keep, but some viewers may ignore it.
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "1F2A44" } },
                    alignment: { vertical: "center", horizontal: "center", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "2D3A55" } },
                        bottom: { style: "thin", color: { rgb: "2D3A55" } },
                        left: { style: "thin", color: { rgb: "2D3A55" } },
                        right: { style: "thin", color: { rgb: "2D3A55" } },
                    }
                };

                for (let c = range.s.c; c <= range.e.c; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 0, c });
                    if (ws[addr]) ws[addr].s = headerStyle;
                }

                const wrapStyle = { alignment: { vertical: "top", wrapText: true } };
                for (let r = 1; r <= range.e.r; r++) {
                    for (const c of [7, 8]) { // OldCode, NewCode
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (ws[addr]) ws[addr].s = wrapStyle;
                    }
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Diff report");
                XLSX.writeFile(wb, "compare_report.xlsx");
            } catch (e) {
                alert("XLSX export failed: " + (e?.message || e));
                console.error(e);
            }
        }

        function updateStats() {
            const counts = state.results.reduce((acc, r) => {
                acc[r.status] = (acc[r.status] || 0) + 1;
                return acc;
            }, {});
            $("stats").textContent =
                `Total: ${state.results.length} | ` +
                `✅ ${counts.UNCHANGED || 0} | ❌ ${counts.CHANGED || 0} | ➕ ${counts.ADDED || 0} | ➖ ${counts.REMOVED || 0}`;
        }

        function applyViewFilters() {
            const mode = $("showOnly").value;
            const q = $("search").value.trim().toLowerCase();

            let rows = state.results.slice();

            if (mode !== "all") {
                rows = rows.filter(r => {
                    if (mode === "changed") return r.status === "CHANGED";
                    if (mode === "unchanged") return r.status === "UNCHANGED";
                    if (mode === "added") return r.status === "ADDED";
                    if (mode === "removed") return r.status === "REMOVED";
                    return true;
                });
            }

            if (q) {
                rows = rows.filter(r => {
                    const keyText = (r.keyPrimary || r.key || "").toLowerCase();
                    const full = (r.key || "").toLowerCase();
                    return keyText.includes(q) || full.includes(q);
                });
            }

            state.viewRows = rows;
            state.page = 1;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const pageSize = state.pageSize;
            const total = state.viewRows.length;
            const maxPage = Math.max(1, Math.ceil(total / pageSize));
            state.page = Math.min(state.page, maxPage);

            const start = (state.page - 1) * pageSize;
            const end = Math.min(total, start + pageSize);
            const slice = state.viewRows.slice(start, end);

            renderResultsTable(slice);

            $("prevPageBtn").disabled = state.page <= 1;
            $("nextPageBtn").disabled = state.page >= maxPage;
            $("pageInfo").textContent = `page ${state.page}/${maxPage}`;
        }

        function renderResultsTable(rows) {
            const tbody = $("resultsTable").querySelector("tbody");
            tbody.innerHTML = "";

            rows.forEach((r) => {
                const tr = document.createElement("tr");
                if (state.selectedKey === r.key) tr.classList.add("selected");

                const keyPrimaryText = r.keyPrimary || r.key;
                tr.innerHTML = `
          <td>${statusPill(r.status)}</td>
          <td class="mono">
            <div class="keyCell">
              <span class="keyText" title="${escapeHtml(keyPrimaryText)}">${escapeHtml(keyPrimaryText)}</span>
              <button class="copyBtn" type="button" title="Copy key">⧉</button>
            </div>
          </td>
          <td>${escapeHtml(r.oldAuthor ?? "")}</td>
          <td>${escapeHtml(r.newAuthor ?? "")}</td>
          <td>${escapeHtml(r.oldDate ?? "")}</td>
          <td>${escapeHtml(r.newDate ?? "")}</td>
          <td class="muted">${escapeHtml(r.preview ?? "")}</td>
        `;

                // copy key button
                tr.querySelector(".copyBtn").addEventListener("click", async (e) => {
                    e.stopPropagation();
                    try {
                        await navigator.clipboard.writeText(keyPrimaryText);
                        showToast("Copied key");
                    } catch {
                        // fallback
                        downloadText("key.txt", keyPrimaryText, "text/plain");
                        showToast("Clipboard blocked, downloaded key.txt");
                    }
                });

                tr.addEventListener("click", () => {
                    selectRowAndRenderDiff(r.key);
                });

                tbody.appendChild(tr);
            });
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function clearDiff() {
            $("diffTitle").textContent = "Select a row with ❌ to view differences.";
            $("oldDiff").textContent = "";
            $("newDiff").textContent = "";
            state.selectedKey = null;
        }

        function selectRowAndRenderDiff(key) {
            state.selectedKey = key;

            // Update row highlighting
            const tbody = $("resultsTable").querySelector("tbody");
            Array.from(tbody.querySelectorAll("tr")).forEach(tr => tr.classList.remove("selected"));
            // Re-render page so selection aligns even when paging/filtering changes
            renderCurrentPage();

            const row = state.results.find(x => x.key === key);
            if (!row) return;

            $("diffTitle").textContent = `${row.status}: ${row.keyPrimary || row.key}`;

            const { oldCode, newCode } = getCodeForKey(key);
            const aligned = buildAlignedDiff(oldCode, newCode);

            renderDiff($("oldDiff"), aligned.oldLines, aligned.oldCls);
            renderDiff($("newDiff"), aligned.newLines, aligned.newCls);
        }

        async function handleFilesChanged() {
            const oldFile = $("oldFile").files[0];
            const newFile = $("newFile").files[0];

            state.oldRows = [];
            state.newRows = [];
            state.cols = [];
            state.results = [];
            state.oldMap = new Map();
            state.newMap = new Map();
            state.reportCsv = "";
            state.viewRows = [];
            state.page = 1;
            state.selectedKey = null;

            $("compareBtn").disabled = true;
            $("exportCsvBtn").disabled = true;
            $("exportXlsxBtn").disabled = true;

            $("oldInfo").textContent = "";
            $("newInfo").textContent = "";
            $("stats").textContent = "";
            $("pageInfo").textContent = "";

            clearDiff();
            $("resultsTable").querySelector("tbody").innerHTML = "";

            if (!oldFile || !newFile) return;

            try {
                const [oldRows, newRows] = await Promise.all([readFile(oldFile), readFile(newFile)]);
                state.oldRows = oldRows;
                state.newRows = newRows;

                const cols = Array.from(new Set([...getColumns(oldRows), ...getColumns(newRows)]));
                state.cols = cols;

                fillSelect($("colKey"), cols);
                fillSelect($("colKey2"), cols);
                fillSelect($("colCode"), cols);
                fillSelect($("colAuthor"), cols);
                fillSelect($("colDate"), cols);

                $("colKey").value = guessColumn(cols, ["object", "object_name", "name", "objectname", "obj", "program", "class"]);
                $("colKey2").value = guessColumn(cols, ["include", "method", "type", "component", "member"]);
                $("colCode").value = guessColumn(cols, ["code", "snippet", "source", "body", "content"]);
                $("colAuthor").value = guessColumn(cols, ["author", "createdby", "changedby", "user", "person"]);
                $("colDate").value = guessColumn(cols, ["date", "changedon", "createdon", "timestamp", "time"]);

                $("oldInfo").textContent = `${oldFile.name} (${oldRows.length} rows)`;
                $("newInfo").textContent = `${newFile.name} (${newRows.length} rows)`;

                $("compareBtn").disabled = false;
            } catch (err) {
                alert("Failed to read files: " + err.message);
            }
        }

        function compare() {
            const colKey = $("colKey").value;
            const colKey2 = $("colKey2").value;
            const colCode = $("colCode").value;

            if (!colKey) { alert("Choose a key/object column."); return; }
            if (!colCode) { alert("Choose a code snippet column."); return; }

            const colAuthor = $("colAuthor").value;
            const colDate = $("colDate").value;
            const mode = $("normalizeMode").value;
            const ignoreBlankLines = $("ignoreBlankLines").checked;

            const keyCols = colKey2 ? [colKey, colKey2] : [colKey];

            const authorSet = linesToSet($("filterAuthors").value);
            const objectSet = linesToSet($("filterObjects").value);

            function passFilters(row) {
                if (authorSet.size && colAuthor) {
                    const a = (row?.[colAuthor] ?? "").toString().trim().toLowerCase();
                    if (!authorSet.has(a)) return false;
                }
                if (objectSet.size) {
                    // Keep UI behavior as you already had (substring match against full composite key)
                    const fullKey = buildKey(row, keyCols).toLowerCase();
                    let ok = false;
                    for (const o of objectSet) {
                        if (fullKey.includes(o)) { ok = true; break; }
                    }
                    if (!ok) return false;
                }
                return true;
            }

            const oldFiltered = state.oldRows.filter(passFilters);
            const newFiltered = state.newRows.filter(passFilters);

            const oldMap = dedupeLatestByDate(oldFiltered, keyCols, colDate || "");
            const newMap = dedupeLatestByDate(newFiltered, keyCols, colDate || "");

            state.oldMap = oldMap;
            state.newMap = newMap;

            const allKeys = new Set([...oldMap.keys(), ...newMap.keys()]);

            const results = [];
            for (const key of allKeys) {
                const o = oldMap.get(key);
                const n = newMap.get(key);

                const oldCode = normalizeCode(o?.[colCode] ?? "", mode, ignoreBlankLines);
                const newCode = normalizeCode(n?.[colCode] ?? "", mode, ignoreBlankLines);

                let status = "UNCHANGED";
                if (o && !n) status = "REMOVED";
                else if (!o && n) status = "ADDED";
                else if (oldCode !== newCode) status = "CHANGED";

                let preview = "";
                if (status === "CHANGED") {
                    const aligned = buildAlignedDiff(oldCode, newCode);
                    preview = `${aligned.sameLines}/${aligned.totalLines} lines match`;
                } else if (status === "ADDED") preview = "Only in new file";
                else if (status === "REMOVED") preview = "Only in old file";
                else preview = "Identical";

                const keyPrimaryVal = (o?.[colKey] ?? n?.[colKey] ?? "").toString().trim();
                const keySecondaryVal = colKey2 ? (o?.[colKey2] ?? n?.[colKey2] ?? "").toString().trim() : "";

                results.push({
                    key,
                    keyPrimary: keyPrimaryVal,
                    keySecondary: keySecondaryVal,
                    status,
                    oldAuthor: colAuthor ? (o?.[colAuthor] ?? "") : "",
                    newAuthor: colAuthor ? (n?.[colAuthor] ?? "") : "",
                    oldDate: colDate ? (o?.[colDate] ?? "") : "",
                    newDate: colDate ? (n?.[colDate] ?? "") : "",
                    preview
                });
            }

            const rank = { CHANGED: 0, ADDED: 1, REMOVED: 2, UNCHANGED: 3 };
            results.sort((a, b) =>
                (rank[a.status] ?? 9) - (rank[b.status] ?? 9) ||
                (a.keyPrimary || a.key).localeCompare(b.keyPrimary || b.key)
            );

            state.results = results;

            updateStats();
            applyViewFilters();

            // Export only diffs
            const exportOnly = state.results.filter(r => r.status !== "UNCHANGED");
            state.reportCsv = buildReportCsv(exportOnly);

            $("exportCsvBtn").disabled = exportOnly.length === 0;
            $("exportXlsxBtn").disabled = exportOnly.length === 0;

            // Auto-select first CHANGED row
            const firstChanged = state.results.find(r => r.status === "CHANGED");
            if (firstChanged) {
                selectRowAndRenderDiff(firstChanged.key);
            } else {
                clearDiff();
            }
        }

        // Debounce helper (for search)
        function debounce(fn, ms) {
            let t = null;
            return (...args) => {
                if (t) clearTimeout(t);
                t = setTimeout(() => fn(...args), ms);
            };
        }

        // Events
        $("oldFile").addEventListener("change", handleFilesChanged);
        $("newFile").addEventListener("change", handleFilesChanged);
        $("compareBtn").addEventListener("click", compare);

        $("exportCsvBtn").addEventListener("click", () => {
            downloadText("compare_report.csv", state.reportCsv, "text/csv");
        });

        $("exportXlsxBtn").addEventListener("click", () => {
            const exportOnly = state.results.filter(r => r.status !== "UNCHANGED");
            exportReportXlsx(exportOnly);
        });

        $("showOnly").addEventListener("change", applyViewFilters);
        $("search").addEventListener("input", debounce(applyViewFilters, 150));

        $("pageSize").addEventListener("change", () => {
            state.pageSize = parseInt($("pageSize").value, 10) || 50;
            state.page = 1;
            renderCurrentPage();
        });

        $("prevPageBtn").addEventListener("click", () => {
            state.page = Math.max(1, state.page - 1);
            renderCurrentPage();
        });

        $("nextPageBtn").addEventListener("click", () => {
            const maxPage = Math.max(1, Math.ceil(state.viewRows.length / state.pageSize));
            state.page = Math.min(maxPage, state.page + 1);
            renderCurrentPage();
        });

        // Changing normalization should update preview + diffs on next compare
        $("normalizeMode").addEventListener("change", () => {
            if (state.results.length) compare();
        });
        $("ignoreBlankLines").addEventListener("change", () => {
            if (state.results.length) compare();
        });

        // Splitter
        (function enableSplitter() {
            const splitRow = document.querySelector(".splitRow");
            const splitter = document.getElementById("splitter");
            if (!splitRow || !splitter) return;

            let dragging = false;
            const minLeft = 360;
            const minRight = 420;
            const splitterW = 18;
            let ratio = null;

            function getGapPx() {
                const cs = getComputedStyle(splitRow);
                const g = parseFloat(cs.columnGap || cs.gap || "0");
                return Number.isFinite(g) ? g : 0;
            }

            function applyColsFromLeft(leftPx) {
                const gap = getGapPx();
                const total = splitRow.getBoundingClientRect().width;
                const usableTotal = total - (2 * gap);
                const maxLeft = usableTotal - splitterW - minRight;

                const clampedLeft = Math.max(minLeft, Math.min(leftPx, maxLeft));
                const right = Math.max(minRight, usableTotal - splitterW - clampedLeft);

                splitRow.style.gridTemplateColumns = `${clampedLeft}px ${splitterW}px ${right}px`;

                const usable = usableTotal - splitterW;
                ratio = usable > 0 ? (clampedLeft / usable) : null;
            }

            function applyColsFromRatio() {
                if (ratio == null) return;

                const gap = getGapPx();
                const total = splitRow.getBoundingClientRect().width;
                const usableTotal = total - (2 * gap);

                const usable = usableTotal - splitterW;
                if (usable <= 0) return;

                const leftPx = usable * ratio;
                applyColsFromLeft(leftPx);
            }

            splitter.addEventListener("mousedown", (e) => {
                dragging = true;
                splitter.classList.add("dragging");
                document.body.style.userSelect = "none";
                document.body.style.cursor = "col-resize";
                e.preventDefault();
            });

            window.addEventListener("mousemove", (e) => {
                if (!dragging) return;
                const rect = splitRow.getBoundingClientRect();
                const leftPx = e.clientX - rect.left;
                applyColsFromLeft(leftPx);
            });

            window.addEventListener("mouseup", () => {
                if (!dragging) return;
                dragging = false;
                splitter.classList.remove("dragging");
                document.body.style.userSelect = "";
                document.body.style.cursor = "";
            });

            window.addEventListener("resize", () => {
                applyColsFromRatio();
            });

            splitter.addEventListener("dblclick", () => {
                ratio = null;
                splitRow.style.gridTemplateColumns = "";
            });
        })();

        // Init
        state.pageSize = parseInt($("pageSize").value, 10) || 50;
    </script>
</body>

</html>